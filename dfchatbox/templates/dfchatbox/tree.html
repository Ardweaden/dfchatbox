{% load staticfiles %} 
<!doctype html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Vpis</title>
        <link rel="stylesheet" href="{% static 'dfchatbox/css/jqtree.css' %}">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'dfchatbox/css/tree.css' %}">
    </head>

    <body>
        <div id="chartsHolder"></div>

        <div id="tree1"></div>

        <div id="tableHolder">
        </div>

    </body>

    <script src="{% static 'dfchatbox/js/jquery-2.2.1.min.js' %}"></script>
    <script src="{% static 'dfchatbox/js/tree.jquery.js' %}"></script>
    <script src="{% static 'dfchatbox/js/treeparser.js' %}"></script>
    <script src="{% static 'dfchatbox/js/tableparser.js' %}"></script>
    <script src="{% static 'dfchatbox/js/chartparser.js' %}"></script>
    <script src="{% static 'dfchatbox/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'dfchatbox/js/chart.js' %}"></script>
    <script src="{% static 'dfchatbox/js/chart.bundle.js' %}"></script>

    <script type="text/javascript">
        var data = {{ data|safe }};
        var tables = [];
        var dates = [];
        
        for (var i = 0; i < data.length; i++) {
            tree_data = data[i];
            converted = parseTree(tree_data);

            tree = converted[0];
            entry_time = converted[1];

            if (entry_time != "No date") {
                unix_time = dates.push(Date.parse(entry_time));
            }
            else {
                dates.push(entry_time)
            }

            tabledata = tableFromTreeWithColspan([tree]);

            tablearray = tabledata[0];
            colspanMatrix = rectangulateArray(tabledata[1]);

            tablee = rectangulateArray(tablearray);

            widthMatrix = calculateWidth(tablee);

            shownTable = tableFromArray(tablee,colspanMatrix,widthMatrix);

            tables.push("<table id='entryTable" + i + "' class='table table-bordered table-striped' style='width: 98%;margin-left: 1%;margin-right: 1%;'>" + shownTable + "</table><br>");

        }

        dates = sortWithIndices(dates);
        sort_indices = dates.sortIndices;

        for (var i = 0; i < dates.length; i++) {
            if (dates[i] != "No date") {
                entry_time = new Date(dates[i]).toLocaleDateString();
            }
            else {
                entry_time = "Ni znan"
            }
            $("#tableHolder").append("<p style='margin-left: 5%;'>Datum vpisa: " + entry_time + "</p><br>");
            $("#tableHolder").append(tables[sort_indices[i]]);
        }

        $("tr").addClass("collapse");
        $("tbody tr:first-child").removeClass("collapse");


        $("tbody tr:first-child").click(function(){
            $(this).siblings(".collapse").toggleClass('show');
        })

        ////////////////////////////////// CHARTS //////////////////////////////////////////

        var rowsToChart = rowsToGraph(data);
        var rows = rowsToChart[0];
        var units = rowsToChart[1];
        
        for (var c = 0; c < rows.length; c++) {
                
            

            var validE = validEntries(data,rowsToGraph(data)[0][c])
            var valid = validE[0];
            var validData = validE[1];
            var title = Object.keys(data[0])[rows[c]];

            $("#chartsHolder").append('<div><button class="btn btn-default chartBtn" id="btnHolder' + c + '">' + title + '</button><div id="chartHolder' + c + '" class="collapse"><canvas id="chart' + c + '" class="chartjs-render-monitor "></canvas></div></div><br>');

            var chartData = [];

            for (var i = 0; i < valid.length; i++) {
                chartData.push({x: new Date(dates[i]) ,y: validData[i]});
            }

            console.log(chartData)

            var ctx = document.getElementById("chart" + c).getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: title,
                        data: chartData,
                        backgroundColor: [
                            //'#d3d8ea'
                            'rgba(255, 99, 132, 0.2)',
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    title: {
                        display: true,
                        text: title,
                        fontSize: 40
                    },
                    tooltips: {
                        titleFontSize: 30,
                        bodyFontSize: 30
                      },
                    scales: {
                        xAxes: [{
                          type: 'time',
                          time: {
                            unit: 'day',
                            unitStepSize: 2,
                            displayFormats: {
                               'day': 'DD-MM-YYYY'
                                }
                            },
                            ticks: {
                                fontSize: 25,
                            }   
                        }],
                        yAxes: [{
                            ticks: {
                                fontSize: 25,
                            },
                            scaleLabel: {
                                display: true,
                                labelString: units[c],
                                fontSize: 30,
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0
                              }
                        }]
                    }
                }
            });
        }

        $(".chartBtn").click(function() {
            $(this).siblings(".collapse").toggleClass("show");
        })
        


    </script>

</html>